# Use the official Python image based on Debian Bullseye for better support
FROM python:3.10-bullseye

# Set the working directory in the container
WORKDIR /app

# Install system-level dependencies (PostgreSQL client, Tesseract, and others)
RUN apt-get update && \
    apt-get install -y wget gnupg && \
    wget -qO - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add - && \
    echo "deb http://apt.postgresql.org/pub/repos/apt/ bullseye-pgdg main" > /etc/apt/sources.list.d/pgdg.list && \
    apt-get update && \
    apt-get install -y libpq-dev postgresql-client


# Copy the requirements file and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy the rest of the application code
COPY . .

# Expose the default port for local testing
EXPOSE 8501

# Set Streamlit environment variables
ENV STREAMLIT_SERVER_PORT=8501
ENV STREAMLIT_SERVER_ADDRESS=0.0.0.0
ENV STREAMLIT_SERVER_ENABLECORS=false

# Ensure DATABASE_URL is set dynamically in your environment for security (via CI/CD or Docker secrets)
ENV DATABASE_URL=postgres://u37ldn7c41r5qm:pe596a74a2616dd045312c8a51acbff0266d7993e2d416f5a39e9166fd29c5138@ccaml3dimis7eh.cluster-czz5s0kz4scl.eu-west-1.rds.amazonaws.com:5432/d55f0k7o8fa1gt

# Run the Streamlit app
CMD ["streamlit", "run", "runner.py", "--server.port=8501", "--server.address=0.0.0.0"]
