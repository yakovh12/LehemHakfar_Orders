# Use the official Python image based on Debian Bullseye for better support
FROM python:3.10-bullseye

# Set the working directory in the container
WORKDIR /app

# Install system-level dependencies (PostgreSQL client, Tesseract, and others)
RUN apt-get update && \
    apt-get install -y wget gnupg supervisor && \
    wget -qO - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add - && \
    echo "deb http://apt.postgresql.org/pub/repos/apt/ bullseye-pgdg main" > /etc/apt/sources.list.d/pgdg.list && \
    apt-get update && \
    apt-get install -y libpq-dev postgresql-client tesseract-ocr && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Copy the requirements file and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy the rest of the application code
COPY . .

# Create logs directory for supervisor
RUN mkdir -p /app/logs

# Expose ports for Flask and Streamlit
EXPOSE 8080 8501

# Copy supervisor configuration for running both services
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Command to run both services using Supervisor
CMD ["supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
